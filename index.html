<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scholar Zolo - Night Attendance</title>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #121212; color: #ffffff; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        
        #camera-wrapper { position: relative; width: 100%; max-width: 350px; aspect-ratio: 3/4; background-color: #222; border-radius: 20px; overflow: hidden; border: 3px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: none; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        canvas { position: absolute; top: 0; left: 0; transform: scaleX(-1); }

        /* The Student Details Card (Hidden by default) */
        #student-card {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; max-width: 320px;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(10px);
            border: 2px solid #00ff88;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            display: none; /* Hidden until success */
            box-shadow: 0 0 50px rgba(0, 255, 136, 0.2);
            z-index: 100;
        }
        #student-card img { width: 100px; height: 100px; border-radius: 50%; border: 3px solid #00ff88; margin-bottom: 15px; object-fit: cover; }
        #student-card h2 { margin: 0; color: #00ff88; font-size: 22px; }
        #student-card p { margin: 5px 0; color: #ccc; font-size: 14px; }
        #student-card .info-row { display: flex; justify-content: space-between; margin-top: 15px; border-top: 1px solid #444; padding-top: 10px; }
        
        button { background-color: #007aff; color: white; border: none; padding: 18px 40px; font-size: 18px; border-radius: 12px; cursor: pointer; font-weight: 600; margin-top: 20px; }
        button:disabled { background-color: #444; color: #888; cursor: wait; }
        #status { margin-top: 20px; font-size: 16px; font-weight: 500; min-height: 24px;}
        .success { color: #00ff88; text-shadow: 0 0 10px rgba(0,255,136,0.3); }
        .error { color: #ff4444; }
    </style>
</head>
<body>

    <h2 style="margin-bottom: 5px;">Scholar Zolo</h2>
    <p style="color:#777; margin-top:0;">Secure Attendance System</p>

    <div id="camera-wrapper">
        <video id="video" autoplay playsinline muted></video>
    </div>

    <div id="student-card">
        <img id="card-img" src="" alt="Student">
        <h2 id="card-name">Student Name</h2>
        <p id="card-roll">Roll No: --</p>
        <div class="info-row">
            <div>
                <p style="font-size:10px; color:#888;">HOSTEL BLOCK</p>
                <p id="card-block" style="color:white; font-weight:bold;">--</p>
            </div>
            <div>
                <p style="font-size:10px; color:#888;">ROOM NO</p>
                <p id="card-room" style="color:white; font-weight:bold;">--</p>
            </div>
            <div>
                <p style="font-size:10px; color:#888;">TIME</p>
                <p id="card-time" style="color:white; font-weight:bold;">--</p>
            </div>
        </div>
        <button onclick="location.reload()" style="background:#333; margin-top:20px; padding:10px 20px; font-size:14px;">Close</button>
    </div>

    <button id="start-btn" onclick="initApp()">üìç Verify Identity</button>
    <div id="status">Ready</div>

    <script>
        // --- 1. STUDENT DICTIONARY (DATABASE) ---
        // Add as many students as you want here!
        const STUDENT_DATABASE = {
            "230955": {
                name: "Sanskar Jaiswal",
                block: "HB-4",
                room: "302",
                // Paste your long numbers array here:
                descriptor: [-0.10651249438524246,0.18682342767715454,0.030025772750377655,0.0597865954041481,-0.03422766551375389,0.008696001954376698,-0.018361791968345642,-0.05388065055012703,0.1480509638786316,-0.07772717624902725,0.20302365720272064,-0.0489942841231823,-0.16818548738956451,-0.17404504120349884,0.04553290456533432,0.15252362191677094,-0.14591968059539795,-0.15702958405017853,-0.07042010128498077,-0.1297890543937683,-0.03127942979335785,0.03627530485391617,0.021350037306547165,0.024174416437745094,-0.13216930627822876,-0.39184117317199707,-0.04722302779555321,-0.213333398103714,0.08022776991128922,-0.12750685214996338,-0.11120283603668213,0.010999293997883797,-0.1709655523300171,-0.0692744255065918,0.04785255715250969,0.09364595264196396,-0.07404015958309174,0.012504657730460167,0.1660287231206894,0.08096040785312653,-0.09956599771976471,-0.017374319955706596,0.00833385530859232,0.35778000950813293,0.16125503182411194,0.07337914407253265,-0.018541021272540092,-0.008995099924504757,0.057226113975048065,-0.1453532725572586,0.10733113437891006,0.13188990950584412,0.16438676416873932,0.1115197166800499,0.07700592279434204,-0.16532081365585327,-0.0028583710081875324,-0.029965374618768692,-0.18230286240577698,0.035991471260786057,0.02863195724785328,-0.0558345653116703,-0.07593853026628494,0.010942112654447556,0.348543256521225,0.09120941907167435,-0.09081186354160309,-0.0747431293129921,0.1811356097459793,-0.10597250610589981,0.032200541347265244,0.04753363877534866,-0.09860517829656601,-0.13396196067333221,-0.18846814334392548,0.1410064846277237,0.45358631014823914,0.12140689045190811,-0.18467175960540771,-0.03920607268810272,-0.10799363255500793,-0.08673296868801117,0.038858894258737564,0.09900973737239838,-0.13344353437423706,0.012968548573553562,-0.03955121710896492,0.045274753123521805,0.12248621135950089,-0.030933544039726257,-0.05085388198494911,0.14642451703548431,-0.040817372500896454,0.03071160614490509,0.03887467831373215,-0.10176144540309906,-0.09837093204259872,-0.005263424012809992,-0.07781867682933807,-0.10289531201124191,0.03172345459461212,-0.17280079424381256,-0.022891027852892876,0.09636249393224716,-0.1927006095647812,0.09081775695085526,0.07299776375293732,-0.05545508489012718,0.014620764181017876,0.11170022189617157,-0.14487811923027039,-0.11120466887950897,0.14856559038162231,-0.27151331305503845,0.23440691828727722,0.1879683881998062,0.06657587736845016,0.17299717664718628,0.0542137585580349,0.09039709717035294,0.018023202195763588,-0.024208230897784233,-0.11325273662805557,-0.04293964058160782,0.07106306403875351,-0.0031580927316099405,0.020327458158135414,0.019016319885849953]
            },
            // "230956": { name: "Aditya", block: "HB-4", descriptor: [...] }
        };

        const TEST_MODE = false; 
        const HOSTEL_POLYGON = [
            { lat: 13.128425, lng: 77.589451 }, { lat: 13.128249, lng: 77.589476 },
            { lat: 13.128287, lng: 77.588653 }, { lat: 13.128426, lng: 77.588660 }
        ];

        const statusEl = document.getElementById('status');
        const cameraWrapper = document.getElementById('camera-wrapper');
        const startBtn = document.getElementById('start-btn');
        const cardEl = document.getElementById('student-card');
        let videoEl;
        let watchId;
        let isGpsInside = false;
        let recognitionLoop;

        async function initApp() {
            startBtn.disabled = true;
            statusEl.innerText = "Downloading AI Models...";
            const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            
            try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                startCamera();
                startGPS(); 
            } catch (err) { statusEl.innerText = "Error loading models."; }
        }

        async function startCamera() {
            cameraWrapper.style.display = 'block';
            startBtn.style.display = 'none';
            videoEl = document.getElementById('video');
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
            videoEl.srcObject = stream;
            videoEl.onloadedmetadata = () => { videoEl.play(); startRecognition(); };
        }

        async function startRecognition() {
            // 1. Build LabeledDescriptors from Dictionary
            const labeledDescriptors = Object.keys(STUDENT_DATABASE).map(rollNo => {
                const student = STUDENT_DATABASE[rollNo];
                return new faceapi.LabeledFaceDescriptors(rollNo, [new Float32Array(student.descriptor)]);
            });
            const faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.55);

            statusEl.innerText = "Scanning...";
            const canvas = faceapi.createCanvasFromMedia(videoEl);
            cameraWrapper.append(canvas);
            const displaySize = { width: videoEl.clientWidth, height: videoEl.clientHeight };
            faceapi.matchDimensions(canvas, displaySize);

            recognitionLoop = setInterval(async () => {
                const detection = await faceapi.detectSingleFace(videoEl, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                const ctx = canvas.getContext('2d'); ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (detection) {
                    const match = faceMatcher.findBestMatch(detection.descriptor);
                    const box = faceapi.resizeResults(detection, displaySize).detection.box;
                    new faceapi.draw.DrawBox(box, { label: match.toString() }).draw(canvas);

                    // IF MATCH FOUND (AND IT'S NOT UNKNOWN)
                    if (match.label !== 'unknown') {
                        checkAttendance(match.label); // Pass the Roll No (Key)
                    } else {
                        statusEl.innerText = "‚ùå Unknown Face";
                    }
                }
            }, 500);
        }

        function startGPS() {
            if(TEST_MODE) { isGpsInside = true; return; }
            if(!navigator.geolocation) return;
            watchId = navigator.geolocation.watchPosition(pos => {
                const u = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                isGpsInside = isPointInPolygon(u, HOSTEL_POLYGON);
            }, e => console.log(e), {enableHighAccuracy:true});
        }

        function checkAttendance(rollNo) {
            if (isGpsInside) {
                showSuccess(rollNo);
            } else {
                statusEl.innerText = "‚úÖ Face Matched, but ‚ùå Outside Hostel!";
            }
        }

        function showSuccess(rollNo) {
            clearInterval(recognitionLoop); // Stop scanning
            navigator.geolocation.clearWatch(watchId); // Stop GPS
            videoEl.pause(); // FREEZE VIDEO
            
            // Get Details
            const student = STUDENT_DATABASE[rollNo];
            
            // Capture Image for card
            const canvas = document.createElement('canvas');
            canvas.width = videoEl.videoWidth; canvas.height = videoEl.videoHeight;
            canvas.getContext('2d').drawImage(videoEl, 0, 0);
            
            // Fill Card
            document.getElementById('card-img').src = canvas.toDataURL(); // Use captured frame
            document.getElementById('card-name').innerText = student.name;
            document.getElementById('card-roll').innerText = "Roll No: " + rollNo;
            document.getElementById('card-block').innerText = student.block;
            document.getElementById('card-room').innerText = student.room;
            document.getElementById('card-time').innerText = new Date().toLocaleTimeString();
            
            // Show Card
            cardEl.style.display = 'block';
            statusEl.innerText = "‚úÖ ATTENDANCE MARKED";
            statusEl.className = "success";
        }

        function isPointInPolygon(p, polygon) {
            let inside = false;
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                let xi = polygon[i].lat, yi = polygon[i].lng;
                let xj = polygon[j].lat, yj = polygon[j].lng;
                let intersect = ((yi > p.lng) != (yj > p.lng)) && (p.lat < (xj - xi) * (p.lng - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            return inside;
        }
    </script>
</body>
</html>
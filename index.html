<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scholar Zolo - Night Attendance</title>
    
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #121212;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            overflow: hidden; /* Prevent scrolling */
        }
        h1 { margin-bottom: 5px; font-weight: 700; color: #00aaff; }
        p { color: #aaaaaa; margin-bottom: 30px; margin-top: 0; font-size: 14px;}
        
        /* Container for Video + AI Canvas */
        #camera-wrapper {
            position: relative;
            width: 100%;
            max-width: 350px;
            aspect-ratio: 3/4;
            background-color: #222;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
            display: none; /* Hidden until started */
            border: 2px solid #333;
        }
        
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            transform: scaleX(-1); /* Mirror the webcam like a selfie */
        }

        /* The Canvas where AI draws the box */
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            transform: scaleX(-1); /* Mirror the canvas too */
        }

        button {
            background-color: #007aff;
            color: white;
            border: none;
            padding: 18px 30px;
            font-size: 18px;
            border-radius: 12px;
            cursor: pointer;
            margin-top: 30px;
            transition: background 0.2s, transform 0.1s;
            width: 100%;
            max-width: 320px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,122,255,0.3);
        }
        button:disabled { background-color: #333; color: #666; cursor: not-allowed; box-shadow: none; }
        button:active { transform: scale(0.98); }
        
        #status { margin-top: 25px; font-size: 16px; min-height: 24px; font-weight: 600; letter-spacing: 0.5px;}
        .success { color: #00ff88; text-shadow: 0 0 10px rgba(0,255,136,0.3); }
        .error { color: #ff4444; }
        .info { color: #00aaff; }
        .scanning { color: #ffcc00; animation: blink 1.5s infinite; }

        @keyframes blink { 50% { opacity: 0.5; } }
        
        #debug-log {
            margin-top: 15px;
            font-size: 11px;
            color: #555;
            font-family: "Courier New", monospace;
            line-height: 1.4;
        }
    </style>
</head>
<body>

    <h1>GFAS (Geo Fenced Attendance System)</h1>
    <p>Secure Late Night Attendance</p>

    <div id="camera-wrapper">
        <video id="video" autoplay playsinline muted></video>
        </div>

    <div id="controls">
        <button id="start-btn" onclick="initApp()">üìç Start Attendance Check</button>
    </div>

    <div id="status">Ready to verify...</div>
    <div id="debug-log"></div>

    <script>
        // --- CONFIGURATION ---
        const TEST_MODE = false; // Set to TRUE if you are testing away from hostel

        // YOUR HOSTEL CORNERS (The 4 points you gave me)
        const HOSTEL_POLYGON = [
            { lat: 13.128425, lng: 77.589451 },
            { lat: 13.128249, lng: 77.589476 },
            { lat: 13.128287, lng: 77.588653 },
            { lat: 13.128426, lng: 77.588660 }
        ];

        // --- STATE MANAGEMENT ---
        let state = {
            gpsReady: false,
            faceReady: false,
            attendanceMarked: false
        };

        const statusEl = document.getElementById('status');
        const debugEl = document.getElementById('debug-log');
        const cameraWrapper = document.getElementById('camera-wrapper');
        const startBtn = document.getElementById('start-btn');
        let videoEl;
        let detectionInterval;
        let watchId; // To stop GPS later

        async function initApp() {
            startBtn.disabled = true;
            statusEl.innerText = "Initializing AI Models...";
            
            try {
                // 1. Load the AI Model (Tiny Face Detector)
                // We assume the model files are in the same directory as index.html
                await faceapi.nets.tinyFaceDetector.loadFromUri('./'); 
                
                // 2. PARALLEL START: Launch Camera AND GPS at the same time
                startCamera(); 
                startGPSStream();

            } catch (err) {
                console.error(err);
                showError("Error: Could not load AI models. Ensure files are uploaded.");
            }
        }

        // --- 1. THE GPS STREAM (Running in Background) ---
        function startGPSStream() {
            if (TEST_MODE) {
                console.log("TEST MODE: GPS automatically valid.");
                state.gpsReady = true;
                updateStatusUI();
                return;
            }

            if (!navigator.geolocation) {
                showError("GPS is not supported by this browser.");
                return;
            }

            // watchPosition updates us every time the phone gets a better fix
            statusEl.innerText = "Requesting GPS Access...";
            
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const userPos = { lat: position.coords.latitude, lng: position.coords.longitude };
                    const accuracy = position.coords.accuracy;

                    debugEl.innerText = `GPS Acc: ${accuracy.toFixed(1)}m | Lat: ${userPos.lat.toFixed(4)}`;

                    // Check if inside Polygon
                    const isInside = isPointInPolygon(userPos, HOSTEL_POLYGON);

                    if (isInside) {
                        state.gpsReady = true;
                        // If we already had the face, this completes the check
                        checkFinalCompletion();
                    } else {
                        state.gpsReady = false; // If they drift out, invalidate it
                    }
                    updateStatusUI();
                },
                (error) => {
                    console.warn("GPS Warning:", error.message);
                    if(error.code === 1) showError("GPS Permission Denied.");
                },
                {
                    enableHighAccuracy: true, // Force GPS hardware
                    timeout: 20000,
                    maximumAge: 0
                }
            );
        }

        // --- 2. THE CAMERA & AI (Foreground) ---
        async function startCamera() {
            cameraWrapper.style.display = 'block';
            startBtn.style.display = 'none';
            videoEl = document.getElementById('video');

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                videoEl.srcObject = stream;
                
                videoEl.onloadedmetadata = () => {
                    videoEl.play();
                    startAIDetection();
                };
            } catch (err) {
                showError("Camera access denied. Check permissions.");
            }
        }

        async function startAIDetection() {
            // Create a canvas to draw the detection box
            const canvas = faceapi.createCanvasFromMedia(videoEl);
            cameraWrapper.append(canvas);
            
            // Match canvas size to video size
            const displaySize = { width: videoEl.clientWidth, height: videoEl.clientHeight };
            faceapi.matchDimensions(canvas, displaySize);

            let faceFrames = 0;

            detectionInterval = setInterval(async () => {
                if (state.attendanceMarked) return; // Stop logic if already done

                // DETECT FACES
                const detections = await faceapi.detectAllFaces(videoEl, new faceapi.TinyFaceDetectorOptions());
                
                // Draw boxes
                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                faceapi.draw.drawDetections(canvas, resizedDetections);

                if (detections.length > 0) {
                    faceFrames++;
                    // Require 10 continuous frames (~1 second) of face visibility
                    if (faceFrames > 10) {
                        state.faceReady = true;
                        checkFinalCompletion();
                    }
                } else {
                    faceFrames = 0;
                    state.faceReady = false;
                }
                updateStatusUI();
            }, 100); // Check 10 times per second
        }

        // --- 3. THE LOGIC BRAIN ---
        function updateStatusUI() {
            if (state.attendanceMarked) return;

            if (!state.gpsReady && !state.faceReady) {
                statusEl.innerText = "üìç Locating & üòê Scanning...";
                statusEl.className = "scanning";
            } else if (!state.gpsReady && state.faceReady) {
                statusEl.innerText = "Face Detected! Refining GPS Signal..."; // Waiting for GPS accuracy
                statusEl.className = "info";
            } else if (state.gpsReady && !state.faceReady) {
                statusEl.innerText = "Location Verified! Look at Camera.";
                statusEl.className = "info";
            }
        }

        function checkFinalCompletion() {
            // ONLY Finish if BOTH are true
            if (state.gpsReady && state.faceReady && !state.attendanceMarked) {
                state.attendanceMarked = true;
                completeAttendance();
            }
        }

        function completeAttendance() {
            // Stop Loops
            clearInterval(detectionInterval);
            navigator.geolocation.clearWatch(watchId); // Stop GPS to save battery

            statusEl.innerText = "‚úÖ ATTENDANCE MARKED SUCCESSFULLY!";
            statusEl.className = "success";
            
            // Visual Success Cue
            cameraWrapper.style.border = "4px solid #00ff88";
            
            // OPTIONAL: Send data to Firebase here
            console.log("Attendance Data Ready to Send to Server");
        }

        // --- UTILS (Ray Casting for Polygon) ---
        function isPointInPolygon(p, polygon) {
            let inside = false;
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                let xi = polygon[i].lat, yi = polygon[i].lng;
                let xj = polygon[j].lat, yj = polygon[j].lng;
                
                let intersect = ((yi > p.lng) != (yj > p.lng)) &&
                    (p.lat < (xj - xi) * (p.lng - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            return inside;
        }

        function showError(msg) {
            statusEl.innerText = msg;
            statusEl.className = "error";
            startBtn.disabled = false;
            startBtn.style.display = 'block';
        }
    </script>
</body>
</html>
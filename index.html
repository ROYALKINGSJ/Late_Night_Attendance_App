<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Late Night Attendance</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #121212;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            text-align: center;
        }
        h1 { margin-bottom: 10px; }
        p { color: #aaaaaa; margin-bottom: 20px; }
        
        #camera-container {
            width: 300px;
            height: 300px;
            background-color: #333;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            display: none; /* Hidden until location is verified */
        }
        
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Overlay box to guide face positioning */
        .face-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 250px;
            border: 2px solid #00ff88;
            border-radius: 100px;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        button {
            background-color: #007aff;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 12px;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.3s;
        }
        button:disabled { background-color: #555; cursor: not-allowed; }
        button:active { transform: scale(0.98); }

        #status { margin-top: 20px; font-weight: bold; }
        .success { color: #00ff88; }
        .error { color: #ff4444; }
    </style>
</head>
<body>

    <h1>Scholar Zolo</h1>
    <p>Late Night Attendance System</p>

    <div id="camera-container">
        <video id="video" autoplay playsinline></video>
        <div class="face-guide"></div>
    </div>

    <div id="controls">
        <button id="start-btn" onclick="startAttendanceProcess()">üìç Verify Location & Scan</button>
    </div>

    <div id="status">Ready to scan...</div>

    <script>
        // --- CONFIGURATION ---
        // REPLACE THESE WITH YOUR HOSTEL/ROOM COORDINATES
        // You can get these from Google Maps (right-click a location > copy numbers)
        const HOSTEL_LAT = 12.9716; 
        const HOSTEL_LNG = 77.5946; 
        const ALLOWED_RADIUS_METERS = 50; // How close they need to be

        const statusEl = document.getElementById('status');
        const cameraContainer = document.getElementById('camera-container');
        const startBtn = document.getElementById('start-btn');

        function startAttendanceProcess() {
            startBtn.disabled = true;
            statusEl.innerText = "Checking GPS Location...";
            statusEl.className = "";

            if (!navigator.geolocation) {
                showError("Geolocation is not supported by this browser.");
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    
                    const distance = getDistanceFromLatLonInM(userLat, userLng, HOSTEL_LAT, HOSTEL_LNG);
                    
                    // For testing, we log the distance to console
                    console.log(`User is ${distance.toFixed(2)} meters away.`);

                    if (distance <= ALLOWED_RADIUS_METERS) {
                        statusEl.innerText = "‚úÖ Location Verified! Starting Camera...";
                        statusEl.className = "success";
                        openCamera();
                    } else {
                        showError(`‚ùå You are too far from the hostel! (${distance.toFixed(0)}m away)`);
                        startBtn.disabled = false;
                    }
                },
                (error) => {
                    showError("Unable to retrieve location. Please allow GPS access.");
                    startBtn.disabled = false;
                }
            );
        }

        async function openCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user' } // Requests front camera on mobile
                });
                
                const video = document.getElementById('video');
                video.srcObject = stream;
                cameraContainer.style.display = 'block';
                startBtn.style.display = 'none'; // Hide button after success
                
                statusEl.innerText = "Scanning Face...";
                
                // MOCK FACE DETECT for Prototype
                // (In the real version, we'd loop face-api.js here)
                setTimeout(() => {
                    statusEl.innerText = "‚úÖ Attendance Marked Successfully!";
                    statusEl.className = "success";
                    // STOP CAMERA
                    stream.getTracks().forEach(track => track.stop());
                }, 3000); // Fakes a 3-second scan

            } catch (err) {
                showError("Camera access denied. Please allow camera permissions.");
                console.error(err);
            }
        }

        // Haversine Formula to calculate distance between two GPS points
        function getDistanceFromLatLonInM(lat1, lon1, lat2, lon2) {
            var R = 6371; // Radius of the earth in km
            var dLat = deg2rad(lat2-lat1);  
            var dLon = deg2rad(lon2-lon1); 
            var a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            var d = R * c; // Distance in km
            return d * 1000; // Distance in meters
        }

        function deg2rad(deg) {
            return deg * (Math.PI/180)
        }

        function showError(msg) {
            statusEl.innerText = msg;
            statusEl.className = "error";
        }
    </script>
</body>
</html>
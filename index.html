<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scholar Zolo - Night Attendance</title>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #121212; color: #ffffff; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        
        #camera-wrapper { position: relative; width: 100%; max-width: 350px; aspect-ratio: 3/4; background-color: #222; border-radius: 20px; overflow: hidden; border: 3px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: none; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        canvas { position: absolute; top: 0; left: 0; transform: scaleX(-1); }

        /* --- NEW DYNAMIC CARD DESIGN --- */
        #student-card {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 340px;
            background: rgba(20, 20, 20, 0.98);
            border: 2px solid #00ff88;
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            display: none; 
            box-shadow: 0 0 50px rgba(0, 255, 136, 0.2);
            z-index: 100;
        }

        /* Header Section (Fixed) */
        .card-header { position: relative; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #333; }
        #card-img { width: 90px; height: 90px; border-radius: 50%; border: 3px solid #00ff88; object-fit: cover; margin-bottom: 10px; }
        #card-name { margin: 0; color: #00ff88; font-size: 24px; font-weight: 700; letter-spacing: 0.5px; }
        #card-roll { margin: 2px 0; color: #aaa; font-size: 14px; letter-spacing: 1px; }

        /* Time Badge (Top Right) */
        .time-badge {
            position: absolute; top: 0; right: 0;
            background: #004422; color: #00ff88;
            padding: 5px 10px; border-radius: 8px;
            font-size: 11px; font-weight: bold;
            border: 1px solid #00ff88;
            box-shadow: 0 0 10px rgba(0,255,136,0.2);
        }

        /* THE DYNAMIC GRID (Automatic 3 Columns) */
        #details-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* Force 3 items per row */
            gap: 10px;
            text-align: center;
        }

        /* Individual Data Box */
        .data-box { background: #2a2a2a; padding: 8px 5px; border-radius: 8px; }
        .data-label { font-size: 9px; color: #888; text-transform: uppercase; margin-bottom: 3px; font-weight: 600; }
        .data-value { font-size: 12px; color: white; font-weight: bold; word-wrap: break-word; }

        button { background-color: #007aff; color: white; border: none; padding: 18px 40px; font-size: 18px; border-radius: 12px; cursor: pointer; font-weight: 600; margin-top: 20px; }
        button:disabled { background-color: #444; color: #888; cursor: wait; }
        #status { margin-top: 20px; font-size: 16px; font-weight: 500; min-height: 24px;}
        .success { color: #00ff88; text-shadow: 0 0 10px rgba(0,255,136,0.3); }
        .error { color: #ff4444; }
    </style>
</head>
<body>

    <h2 style="margin-bottom: 5px; font-weight: 800; letter-spacing: 1px;">Scholar Zolo</h2>
    <p style="color:#00ff88; margin-top:0; font-size: 12px; font-family: monospace;">POWERED BY GFAS‚Ñ¢</p>

    <div id="camera-wrapper">
        <video id="video" autoplay playsinline muted></video>
    </div>

    <div id="student-card">
        <div class="card-header">
            <div class="time-badge" id="card-time">--:-- AM</div> <img id="card-img" src="" alt="Student">
            <h2 id="card-name">Student Name</h2>
            <p id="card-roll">Roll No: --</p>
        </div>

        <div id="details-grid"></div>

        <button onclick="location.reload()" style="background:#333; margin-top:20px; padding:10px 30px; font-size:14px; width:100%;">Close & Reset</button>
    </div>

    <button id="start-btn" onclick="initApp()">üìç Verify Identity</button>
    <div id="status">Ready</div>

    <script>
        // --- 1. STUDENT DATABASE (Add ANYTHING here!) ---
        const STUDENT_DATABASE = {
            "251580052142": {
                name: "Sanskar Jaiswal",
                descriptor: [-0.10651249438524246,0.18682342767715454,0.030025772750377655,0.0597865954041481,-0.03422766551375389,0.008696001954376698,-0.018361791968345642,-0.05388065055012703,0.1480509638786316,-0.07772717624902725,0.20302365720272064,-0.0489942841231823,-0.16818548738956451,-0.17404504120349884,0.04553290456533432,0.15252362191677094,-0.14591968059539795,-0.15702958405017853,-0.07042010128498077,-0.1297890543937683,-0.03127942979335785,0.03627530485391617,0.021350037306547165,0.024174416437745094,-0.13216930627822876,-0.39184117317199707,-0.04722302779555321,-0.213333398103714,0.08022776991128922,-0.12750685214996338,-0.11120283603668213,0.010999293997883797,-0.1709655523300171,-0.0692744255065918,0.04785255715250969,0.09364595264196396,-0.07404015958309174,0.012504657730460167,0.1660287231206894,0.08096040785312653,-0.09956599771976471,-0.017374319955706596,0.00833385530859232,0.35778000950813293,0.16125503182411194,0.07337914407253265,-0.018541021272540092,-0.008995099924504757,0.057226113975048065,-0.1453532725572586,0.10733113437891006,0.13188990950584412,0.16438676416873932,0.1115197166800499,0.07700592279434204,-0.16532081365585327,-0.0028583710081875324,-0.029965374618768692,-0.18230286240577698,0.035991471260786057,0.02863195724785328,-0.0558345653116703,-0.07593853026628494,0.010942112654447556,0.348543256521225,0.09120941907167435,-0.09081186354160309,-0.0747431293129921,0.1811356097459793,-0.10597250610589981,0.032200541347265244,0.04753363877534866,-0.09860517829656601,-0.13396196067333221,-0.18846814334392548,0.1410064846277237,0.45358631014823914,0.12140689045190811,-0.18467175960540771,-0.03920607268810272,-0.10799363255500793,-0.08673296868801117,0.038858894258737564,0.09900973737239838,-0.13344353437423706,0.012968548573553562,-0.03955121710896492,0.045274753123521805,0.12248621135950089,-0.030933544039726257,-0.05085388198494911,0.14642451703548431,-0.040817372500896454,0.03071160614490509,0.03887467831373215,-0.10176144540309906,-0.09837093204259872,-0.005263424012809992,-0.07781867682933807,-0.10289531201124191,0.03172345459461212,-0.17280079424381256,-0.022891027852892876,0.09636249393224716,-0.1927006095647812,0.09081775695085526,0.07299776375293732,-0.05545508489012718,0.014620764181017876,0.11170022189617157,-0.14487811923027039,-0.11120466887950897,0.14856559038162231,-0.27151331305503845,0.23440691828727722,0.1879683881998062,0.06657587736845016,0.17299717664718628,0.0542137585580349,0.09039709717035294,0.018023202195763588,-0.024208230897784233,-0.11325273662805557,-0.04293964058160782,0.07106306403875351,-0.0031580927316099405,0.020327458158135414,0.019016319885849953],
                hostel: "HB-4",
                wing: "C - Wing",
                room: "1146",
                branch: "CSE" 
            },
            "251580051806": {
                name: "Pranav Jitesh",
                descriptor: [-0.1394231617450714,0.05168241634964943,0.08291475474834442,-0.04620618373155594,-0.028948958963155746,-0.05728144943714142,0.017117394134402275,-0.04486837610602379,0.1592196226119995,-0.09511864930391312,0.2753675580024719,-0.04808979853987694,-0.2287639081478119,-0.12387951463460922,-0.02555258944630623,0.05256105586886406,-0.16837164759635925,-0.17420321702957153,-0.035027652978897095,-0.18209359049797058,0.017948634922504425,0.017509259283542633,-0.038320932537317276,0.08463392406702042,-0.11507360637187958,-0.32268083095550537,-0.0756864994764328,-0.15437819063663483,0.05731571093201637,-0.06311517208814621,0.005110335070639849,0.11196926981210709,-0.16118097305297852,-0.032866064459085464,0.005982604809105396,0.12009225785732269,0.03514906391501427,0.05640453100204468,0.14453203976154327,0.04242170602083206,-0.10184022784233093,-0.03947224095463753,-0.018536774441599846,0.3040686249732971,0.1752292513847351,0.050543446093797684,-0.09080145508050919,0.0076367505826056,0.0411020889878273,-0.20762069523334503,0.009980236180126667,0.22746869921684265,0.14921432733535767,0.06760767847299576,0.04803114011883736,-0.15722264349460602,-0.07117898017168045,0.04994325712323189,-0.1705569326877594,0.04206283390522003,-0.10886530578136444,-0.13388201594352722,-0.030521569773554802,-0.08266964554786682,0.24898701906204224,0.11622007191181183,-0.14961354434490204,-0.11041086167097092,0.2003217339515686,-0.18648770451545715,-0.08042963594198227,0.10538803786039352,-0.12298280745744705,-0.10357443243265152,-0.2268495261669159,0.1136147528886795,0.4060198962688446,0.09527373313903809,-0.17638102173805237,0.023780109360814095,-0.12023179233074188,-0.07465019822120667,-0.016746273264288902,0.07238847017288208,-0.1508541852235794,0.06429296731948853,-0.061631932854652405,-0.007898727431893349,0.10061904042959213,0.02838865853846073,-0.0710725337266922,0.20748330652713776,-0.09798361361026764,0.1472315788269043,0.08445671945810318,-0.04358047991991043,-0.05100885406136513,-0.039172712713479996,-0.14984144270420074,-0.0823243111371994,0.00034101048368029296,-0.1342162936925888,-0.010097603313624859,0.06434058398008347,-0.13298438489437103,0.048046667128801346,0.021524516865611076,-0.029162222519516945,-0.048704247921705246,0.09289807826280594,-0.101187564432621,-0.07068024575710297,0.202409029006958,-0.2814256250858307,0.2220066636800766,0.20017679035663605,0.08045874536037445,0.1689227819442749,0.10965728759765625,0.008000806905329227,-0.018176672980189323,-0.08689533174037933,-0.0648372545838356,-0.025566235184669495,0.04836532846093178,-0.05773644894361496,0.022627899423241615,-0.01038810983300209],
                hostel: "HB-4",
                wing: "C - Wing",
                room: "176",
                branch: "CSE" 
            },
            "251580050880": {
                name: "Dhruv Agarwal",
                descriptor: [-0.1287534087896347,0.10532816499471664,0.018940744921565056,0.06128062307834625,-0.044224731624126434,-0.08392186462879181,0.0234125517308712,-0.046378545463085175,0.19370947778224945,0.0018400056287646294,0.21626660227775574,0.006062242202460766,-0.14473693072795868,-0.039790935814380646,-0.025245795026421547,0.039342332631349564,-0.18057218194007874,-0.09956426173448563,-0.07053618133068085,-0.11993516981601715,0.001210691872984171,-0.008307182230055332,0.029403064399957657,0.10222814977169037,-0.14055024087429047,-0.2807609438896179,-0.12032463401556015,-0.22286084294319153,0.07325955480337143,-0.11374052613973618,-0.0062433574348688126,0.07128912955522537,-0.2004801481962204,-0.12467727065086365,0.010891055688261986,-0.02999943122267723,0.0199125949293375,0.02529403194785118,0.17298829555511475,-0.01900392398238182,-0.06982900947332382,-0.00989403948187828,0.042874883860349655,0.2886417806148529,0.1459188461303711,0.1425723433494568,-0.01282801479101181,-0.022670622915029526,0.04696522653102875,-0.13831399381160736,0.08767753094434738,0.15403339266777039,0.09366434067487717,0.08983445912599564,0.06075082719326019,-0.2156611979007721,-0.01573692262172699,-0.012251416221261024,-0.13836067914962769,0.11064249277114868,-0.010011289268732071,0.007447518408298492,0.004561582580208778,-0.013667424209415913,0.24617764353752136,0.07809753715991974,-0.07886253297328949,-0.06094309315085411,0.159356951713562,-0.1858626902103424,0.007895496673882008,0.08585098385810852,-0.10952018946409225,-0.19521373510360718,-0.20049941539764404,0.09554678201675415,0.4563905894756317,0.15669575333595276,-0.11920327693223953,0.03295747563242912,-0.11033807694911957,-0.10523863136768341,-0.0010977645870298147,0.0627339631319046,-0.16278403997421265,0.04685709998011589,-0.04959616810083389,0.05880284681916237,0.1644401252269745,0.07096001505851746,-0.059417787939310074,0.20057132840156555,-0.06430704146623611,0.02621588669717312,0.04078005999326706,-0.035864945501089096,-0.06618689745664597,-0.007903317920863628,-0.09400204569101334,-0.0029489928856492043,0.0097642932087183,-0.08633294701576233,-0.03789287433028221,0.06400557607412338,-0.1429899036884308,0.0401131734251976,0.02577388472855091,-0.028040006756782532,-0.1178743839263916,0.11447850614786148,-0.15456101298332214,-0.0367731936275959,0.1745367795228958,-0.24561452865600586,0.25522783398628235,0.1398552805185318,0.03654630109667778,0.16683900356292725,0.025649378076195717,0.06407713890075684,0.013178599998354912,-0.03255617618560791,-0.08929359167814255,-0.041953977197408676,0.08800967037677765,-0.0708981454372406,0.0857260525226593,0.027557197958230972],
                hostel: "HB-4",
                wing: "C - Wing",
                room: "459",
                branch: "CSE" 
            },
            "251580050642": {
                name: "Suyash Lehri",
                descriptor: [-0.2217213213443756,0.08336569368839264,0.024715997278690338,-0.008554236963391304,-0.08903186023235321,-0.03815854340791702,-0.006742708384990692,-0.05132124945521355,0.18079914152622223,-0.0529550276696682,0.27352669835090637,-0.0022361946757882833,-0.13683614134788513,-0.13607659935951233,0.01594575121998787,0.1597803682088852,-0.15502072870731354,-0.1584971398115158,-0.08237779885530472,-0.025377396494150162,-0.0033569817896932364,-0.15983204543590546,-0.03140762075781822,0.09399867057800293,-0.15535151958465576,-0.3701212704181671,-0.09831472486257553,-0.1199025809764862,0.031889934092760086,-0.10974955558776855,0.05968121439218521,0.00679697934538126,-0.17291860282421112,-0.027189666405320168,-0.03080272674560547,0.14250615239143372,-0.030139591544866562,-0.05700171738862991,0.20398393273353577,-0.10969575494527817,-0.18747375905513763,-0.029429558664560318,0.036611832678318024,0.2262084186077118,0.22836434841156006,0.009022995829582214,0.06850036978721619,0.021947167813777924,0.11455782502889633,-0.21432025730609894,0.0768483579158783,0.09461971372365952,0.15739986300468445,0.07869698107242584,0.056475281715393066,-0.12749357521533966,0.028318136930465698,0.1397310495376587,-0.1583990752696991,-0.019585467875003815,-0.005068266298621893,-0.07446417212486267,-0.05247312784194946,0.024741249158978462,0.2652197778224945,0.17356441915035248,-0.1484946459531784,-0.12135058641433716,0.15287823975086212,-0.15547418594360352,0.004374407697468996,0.022487398236989975,-0.12021496146917343,-0.19608387351036072,-0.3622981607913971,0.1395554393529892,0.44244781136512756,0.1386641561985016,-0.19907909631729126,0.027879169210791588,-0.04911066219210625,0.012511806562542915,0.014229951426386833,0.08697228133678436,-0.14620205760002136,-0.030988870188593864,-0.15320254862308502,0.0037301182746887207,0.15664440393447876,0.05347331613302231,-0.030645648017525673,0.12502264976501465,-0.009317047894001007,0.0021140174940228462,0.01507653295993805,0.03940476477146149,-0.05371987074613571,-0.0159631185233593,-0.04669427126646042,-0.0054040695540606976,0.08672179281711578,-0.014729238115251064,0.0014884502161294222,0.0760122761130333,-0.15201053023338318,0.12881216406822205,-0.0130656398832798,0.04679768532514572,-0.035756614059209824,0.06975391507148743,-0.11162473261356354,-0.04016626253724098,0.11049394309520721,-0.2328016310930252,0.18777689337730408,0.139804407954216,-0.016128266230225563,0.17590653896331787,0.14556026458740234,0.08141078799962997,0.0023623337037861347,0.01726798340678215,-0.09115178883075714,-0.009052310138940811,0.03388850390911102,-0.02489505335688591,0.11713487654924393,0.050677862018346786],
                hostel: "HB-4",
                wing: "C - Wing",
                room: "459",
                branch: "CSE" 
            },
        };

        const TEST_MODE = true; 
        const HOSTEL_POLYGON = [
            { lat: 13.128425, lng: 77.589451 },
            { lat: 13.128249, lng: 77.589476 },
            { lat: 13.128287, lng: 77.588653 },
            { lat: 13.128426, lng: 77.588660 }
        ];

        const statusEl = document.getElementById('status');
        const cameraWrapper = document.getElementById('camera-wrapper');
        const startBtn = document.getElementById('start-btn');
        const cardEl = document.getElementById('student-card');
        const gridEl = document.getElementById('details-grid');
        let videoEl;
        let watchId;
        let isGpsInside = false;
        let recognitionLoop;

        async function initApp() {
            startBtn.disabled = true;
            statusEl.innerText = "Downloading AI Models...";
            const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            
            try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                startCamera();
                startGPS(); 
            } catch (err) { statusEl.innerText = "Error loading models."; }
        }

        async function startCamera() {
            cameraWrapper.style.display = 'block';
            startBtn.style.display = 'none';
            videoEl = document.getElementById('video');
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
            videoEl.srcObject = stream;
            videoEl.onloadedmetadata = () => { videoEl.play(); startRecognition(); };
        }

        async function startRecognition() {
            const labeledDescriptors = Object.keys(STUDENT_DATABASE).map(rollNo => {
                const student = STUDENT_DATABASE[rollNo];
                return new faceapi.LabeledFaceDescriptors(rollNo, [new Float32Array(student.descriptor)]);
            });
            const faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.55);

            statusEl.innerText = "Scanning...";
            const canvas = faceapi.createCanvasFromMedia(videoEl);
            cameraWrapper.append(canvas);
            const displaySize = { width: videoEl.clientWidth, height: videoEl.clientHeight };
            faceapi.matchDimensions(canvas, displaySize);

            recognitionLoop = setInterval(async () => {
                const detection = await faceapi.detectSingleFace(videoEl, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                const ctx = canvas.getContext('2d'); ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (detection) {
                    const match = faceMatcher.findBestMatch(detection.descriptor);
                    const box = faceapi.resizeResults(detection, displaySize).detection.box;
                    new faceapi.draw.DrawBox(box, { label: match.toString() }).draw(canvas);

                    if (match.label !== 'unknown') {
                        checkAttendance(match.label);
                    } else {
                        statusEl.innerText = "‚ùå Unknown Face";
                    }
                }
            }, 500);
        }

        function startGPS() {
            if(TEST_MODE) { isGpsInside = true; return; }
            if(!navigator.geolocation) return;
            watchId = navigator.geolocation.watchPosition(pos => {
                const u = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                isGpsInside = isPointInPolygon(u, HOSTEL_POLYGON);
            }, e => console.log(e), {enableHighAccuracy:true});
        }

        function checkAttendance(rollNo) {
            if (isGpsInside) {
                showSuccess(rollNo);
            } else {
                statusEl.innerText = "‚úÖ Face Matched, but ‚ùå Outside Hostel!";
            }
        }

        // --- THE NEW DYNAMIC CARD GENERATOR ---
        function showSuccess(rollNo) {
            clearInterval(recognitionLoop);
            navigator.geolocation.clearWatch(watchId);
            videoEl.pause();

            const student = STUDENT_DATABASE[rollNo];

            // 1. Set Header (Fixed Items)
            const canvas = document.createElement('canvas');
            canvas.width = videoEl.videoWidth; canvas.height = videoEl.videoHeight;
            canvas.getContext('2d').drawImage(videoEl, 0, 0);
            
            document.getElementById('card-img').src = canvas.toDataURL();
            document.getElementById('card-name').innerText = student.name;
            document.getElementById('card-roll').innerText = rollNo;
            document.getElementById('card-time').innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            // 2. Clear previous grid items
            gridEl.innerHTML = "";

            // 3. Loop through Database and Create Boxes
            for (let key in student) {
                // Skip the items we already showed in the header
                if (key === 'name' || key === 'descriptor') continue;

                // Create a Box for everything else
                const val = student[key];
                const label = key.replace(/_/g, " "); // Convert "blood_group" -> "blood group"

                const box = document.createElement('div');
                box.className = 'data-box';
                box.innerHTML = `
                    <div class="data-label">${label}</div>
                    <div class="data-value">${val}</div>
                `;
                
                gridEl.appendChild(box);
            }

            // Show Card
            cardEl.style.display = 'block';
            statusEl.innerText = "‚úÖ ATTENDANCE MARKED";
            statusEl.className = "success";
        }

        function isPointInPolygon(p, polygon) {
            let inside = false;
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                let xi = polygon[i].lat, yi = polygon[i].lng;
                let xj = polygon[j].lat, yj = polygon[j].lng;
                let intersect = ((yi > p.lng) != (yj > p.lng)) && (p.lat < (xj - xi) * (p.lng - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            return inside;
        }
    </script>
</body>
</html>
